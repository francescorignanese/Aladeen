/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/@microsoft/signalr@3.1.0/dist/cjs/HttpConnection.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(o,s){function i(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new r(function(e){e(t.value)}).then(i,a)}c((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(exports,"__esModule",{value:!0});var DefaultHttpClient_1=require("./DefaultHttpClient"),ILogger_1=require("./ILogger"),ITransport_1=require("./ITransport"),LongPollingTransport_1=require("./LongPollingTransport"),ServerSentEventsTransport_1=require("./ServerSentEventsTransport"),Utils_1=require("./Utils"),WebSocketTransport_1=require("./WebSocketTransport"),MAX_REDIRECTS=100,WebSocketModule=null,EventSourceModule=null;if(Utils_1.Platform.isNode&&"undefined"!=typeof require){var requireFunc="function"==typeof __webpack_require__?__non_webpack_require__:require;WebSocketModule=requireFunc("ws"),EventSourceModule=requireFunc("eventsource")}var HttpConnection=function(){function t(t,e){void 0===e&&(e={}),this.features={},this.negotiateVersion=1,Utils_1.Arg.isRequired(t,"url"),this.logger=Utils_1.createLogger(e.logger),this.baseUrl=this.resolveUrl(t),(e=e||{}).logMessageContent=e.logMessageContent||!1,Utils_1.Platform.isNode||"undefined"==typeof WebSocket||e.WebSocket?Utils_1.Platform.isNode&&!e.WebSocket&&WebSocketModule&&(e.WebSocket=WebSocketModule):e.WebSocket=WebSocket,Utils_1.Platform.isNode||"undefined"==typeof EventSource||e.EventSource?Utils_1.Platform.isNode&&!e.EventSource&&void 0!==EventSourceModule&&(e.EventSource=EventSourceModule):e.EventSource=EventSource,this.httpClient=e.httpClient||new DefaultHttpClient_1.DefaultHttpClient(this.logger),this.connectionState="Disconnected",this.connectionStarted=!1,this.options=e,this.onreceive=null,this.onclose=null}return t.prototype.start=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(r){switch(r.label){case 0:return t=t||ITransport_1.TransferFormat.Binary,Utils_1.Arg.isIn(t,ITransport_1.TransferFormat,"transferFormat"),this.logger.log(ILogger_1.LogLevel.Debug,"Starting connection with transfer format '"+ITransport_1.TransferFormat[t]+"'."),"Disconnected"!==this.connectionState?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting ",this.startInternalPromise=this.startInternal(t),[4,this.startInternalPromise]);case 1:return r.sent(),"Disconnecting"!==this.connectionState?[3,3]:(e="Failed to start the HttpConnection before stop() was called.",this.logger.log(ILogger_1.LogLevel.Error,e),[4,this.stopPromise]);case 2:return r.sent(),[2,Promise.reject(new Error(e))];case 3:if("Connected"!==this.connectionState)return e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(ILogger_1.LogLevel.Error,e),[2,Promise.reject(new Error(e))];r.label=4;case 4:return this.connectionStarted=!0,[2]}})})},t.prototype.send=function(t){return"Connected"!==this.connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new TransportSendQueue(this.transport)),this.sendQueue.send(t))},t.prototype.stop=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(r){switch(r.label){case 0:return"Disconnected"===this.connectionState?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):"Disconnecting"===this.connectionState?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise(function(t){e.stopPromiseResolver=t}),[4,this.stopInternal(t)]);case 1:return r.sent(),[4,this.stopPromise];case 2:return r.sent(),[2]}})})},t.prototype.stopInternal=function(t){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(n){switch(n.label){case 0:this.stopError=t,n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:return n.sent(),[3,4];case 3:return n.sent(),[3,4];case 4:if(!this.sendQueue)return[3,9];n.label=5;case 5:return n.trys.push([5,7,,8]),[4,this.sendQueue.stop()];case 6:return n.sent(),[3,8];case 7:return e=n.sent(),this.logger.log(ILogger_1.LogLevel.Error,"TransportSendQueue.stop() threw error '"+e+"'."),[3,8];case 8:this.sendQueue=void 0,n.label=9;case 9:if(!this.transport)return[3,14];n.label=10;case 10:return n.trys.push([10,12,,13]),[4,this.transport.stop()];case 11:return n.sent(),[3,13];case 12:return r=n.sent(),this.logger.log(ILogger_1.LogLevel.Error,"HttpConnection.transport.stop() threw error '"+r+"'."),this.stopConnection(),[3,13];case 13:return this.transport=void 0,[3,15];case 14:this.logger.log(ILogger_1.LogLevel.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed."),this.stopConnection(),n.label=15;case 15:return[2]}})})},t.prototype.startInternal=function(t){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,s,i;return __generator(this,function(a){switch(a.label){case 0:e=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,a.label=1;case 1:return a.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==ITransport_1.HttpTransportType.WebSockets?[3,3]:(this.transport=this.constructTransport(ITransport_1.HttpTransportType.WebSockets),[4,this.startTransport(e,t)]):[3,5];case 2:return a.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:r=null,n=0,o=function(){var t;return __generator(this,function(o){switch(o.label){case 0:return[4,s.getNegotiationResponse(e)];case 1:if(r=o.sent(),"Disconnecting"===s.connectionState||"Disconnected"===s.connectionState)throw new Error("The connection was stopped during negotiation.");if(r.error)throw new Error(r.error);if(r.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return r.url&&(e=r.url),r.accessToken&&(t=r.accessToken,s.accessTokenFactory=function(){return t}),n++,[2]}})},s=this,a.label=6;case 6:return[5,o()];case 7:a.sent(),a.label=8;case 8:if(r.url&&n<MAX_REDIRECTS)return[3,6];a.label=9;case 9:if(n===MAX_REDIRECTS&&r.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(e,this.options.transport,r,t)];case 10:a.sent(),a.label=11;case 11:return this.transport instanceof LongPollingTransport_1.LongPollingTransport&&(this.features.inherentKeepAlive=!0),"Connecting "===this.connectionState&&(this.logger.log(ILogger_1.LogLevel.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return i=a.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the connection: "+i),this.connectionState="Disconnected",this.transport=void 0,[2,Promise.reject(i)];case 13:return[2]}})})},t.prototype.getNegotiationResponse=function(t){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,s,i,a;return __generator(this,function(c){switch(c.label){case 0:return this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(n=c.sent())&&((e={}).Authorization="Bearer "+n,r=e),c.label=2;case 2:o=this.resolveNegotiateUrl(t),this.logger.log(ILogger_1.LogLevel.Debug,"Sending negotiation request: "+o+"."),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this.httpClient.post(o,{content:"",headers:r})];case 4:return 200!==(s=c.sent()).statusCode?[2,Promise.reject(new Error("Unexpected status code returned from negotiate "+s.statusCode))]:((!(i=JSON.parse(s.content)).negotiateVersion||i.negotiateVersion<1)&&(i.connectionToken=i.connectionId),[2,i]);case 5:return a=c.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to complete negotiation with the server: "+a),[2,Promise.reject(a)];case 6:return[2]}})})},t.prototype.createConnectUrl=function(t,e){return e?t+(-1===t.indexOf("?")?"?":"&")+"id="+e:t},t.prototype.createTransport=function(t,e,r,n){return __awaiter(this,void 0,void 0,function(){var o,s,i,a,c,u,p,l,h,g,f;return __generator(this,function(d){switch(d.label){case 0:return o=this.createConnectUrl(t,r.connectionToken),this.isITransport(e)?(this.logger.log(ILogger_1.LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,[4,this.startTransport(o,n)]):[3,2];case 1:return d.sent(),this.connectionId=r.connectionId,[2];case 2:s=[],i=r.availableTransports||[],a=r,c=0,u=i,d.label=3;case 3:return c<u.length?(p=u[c],(l=this.resolveTransportOrError(p,e,n))instanceof Error?(s.push(p.transport+" failed: "+l),[3,12]):[3,4]):[3,13];case 4:if(!this.isITransport(l))return[3,12];if(this.transport=l,a)return[3,9];d.label=5;case 5:return d.trys.push([5,7,,8]),[4,this.getNegotiationResponse(t)];case 6:return a=d.sent(),[3,8];case 7:return h=d.sent(),[2,Promise.reject(h)];case 8:o=this.createConnectUrl(t,a.connectionToken),d.label=9;case 9:return d.trys.push([9,11,,12]),[4,this.startTransport(o,n)];case 10:return d.sent(),this.connectionId=a.connectionId,[2];case 11:return g=d.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the transport '"+p.transport+"': "+g),a=void 0,s.push(p.transport+" failed: "+g),"Connecting "!==this.connectionState?(f="Failed to select transport before stop() was called.",this.logger.log(ILogger_1.LogLevel.Debug,f),[2,Promise.reject(new Error(f))]):[3,12];case 12:return c++,[3,3];case 13:return s.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+s.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}})})},t.prototype.constructTransport=function(t){switch(t){case ITransport_1.HttpTransportType.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new WebSocketTransport_1.WebSocketTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket);case ITransport_1.HttpTransportType.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new ServerSentEventsTransport_1.ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource);case ITransport_1.HttpTransportType.LongPolling:return new LongPollingTransport_1.LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1);default:throw new Error("Unknown transport: "+t+".")}},t.prototype.startTransport=function(t,e){var r=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(t){return r.stopConnection(t)},this.transport.connect(t,e)},t.prototype.resolveTransportOrError=function(t,e,r){var n=ITransport_1.HttpTransportType[t.transport];if(null==n)return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+t.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+t.transport+"' because it is not supported by this client.");if(!transportMatches(e,n))return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it was disabled by the client."),new Error("'"+ITransport_1.HttpTransportType[n]+"' is disabled by the client.");if(!(t.transferFormats.map(function(t){return ITransport_1.TransferFormat[t]}).indexOf(r)>=0))return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it does not support the requested transfer format '"+ITransport_1.TransferFormat[r]+"'."),new Error("'"+ITransport_1.HttpTransportType[n]+"' does not support "+ITransport_1.TransferFormat[r]+".");if(n===ITransport_1.HttpTransportType.WebSockets&&!this.options.WebSocket||n===ITransport_1.HttpTransportType.ServerSentEvents&&!this.options.EventSource)return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it is not supported in your environment.'"),new Error("'"+ITransport_1.HttpTransportType[n]+"' is not supported in your environment.");this.logger.log(ILogger_1.LogLevel.Debug,"Selecting transport '"+ITransport_1.HttpTransportType[n]+"'.");try{return this.constructTransport(n)}catch(t){return t}},t.prototype.isITransport=function(t){return t&&"object"==typeof t&&"connect"in t},t.prototype.stopConnection=function(t){if(this.logger.log(ILogger_1.LogLevel.Debug,"HttpConnection.stopConnection("+t+") called while in state "+this.connectionState+"."),this.transport=void 0,t=this.stopError||t,this.stopError=void 0,"Disconnected"!==this.connectionState)if("Connecting "!==this.connectionState){if("Disconnecting"===this.connectionState&&this.stopPromiseResolver(),t?this.logger.log(ILogger_1.LogLevel.Error,"Connection disconnected with error '"+t+"'."):this.logger.log(ILogger_1.LogLevel.Information,"Connection disconnected."),this.connectionId=void 0,this.connectionState="Disconnected",this.onclose&&this.connectionStarted){this.connectionStarted=!1;try{this.onclose(t)}catch(e){this.logger.log(ILogger_1.LogLevel.Error,"HttpConnection.onclose("+t+") threw error '"+e+"'.")}}}else this.logger.log(ILogger_1.LogLevel.Warning,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection hasn't yet left the in the connecting state.");else this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection is already in the disconnected state.")},t.prototype.resolveUrl=function(t){if(0===t.lastIndexOf("https://",0)||0===t.lastIndexOf("http://",0))return t;if(!Utils_1.Platform.isBrowser||!window.document)throw new Error("Cannot resolve '"+t+"'.");var e=window.document.createElement("a");return e.href=t,this.logger.log(ILogger_1.LogLevel.Information,"Normalizing '"+t+"' to '"+e.href+"'."),e.href},t.prototype.resolveNegotiateUrl=function(t){var e=t.indexOf("?"),r=t.substring(0,-1===e?t.length:e);return"/"!==r[r.length-1]&&(r+="/"),r+="negotiate",-1===(r+=-1===e?"":t.substring(e)).indexOf("negotiateVersion")&&(r+=-1===e?"?":"&",r+="negotiateVersion="+this.negotiateVersion),r},t}();function transportMatches(t,e){return!t||0!=(e&t)}exports.HttpConnection=HttpConnection;var TransportSendQueue=function(){function t(t){this.transport=t,this.buffer=[],this.executing=!0,this.sendBufferedData=new PromiseSource,this.transportResult=new PromiseSource,this.sendLoopPromise=this.sendLoop()}return t.prototype.send=function(t){return this.bufferData(t),this.transportResult||(this.transportResult=new PromiseSource),this.transportResult.promise},t.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},t.prototype.bufferData=function(t){if(this.buffer.length&&typeof this.buffer[0]!=typeof t)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof t);this.buffer.push(t),this.sendBufferedData.resolve()},t.prototype.sendLoop=function(){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(o){switch(o.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(o.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new PromiseSource,e=this.transportResult,this.transportResult=void 0,r="string"==typeof this.buffer[0]?this.buffer.join(""):t.concatBuffers(this.buffer),this.buffer.length=0,o.label=2;case 2:return o.trys.push([2,4,,5]),[4,this.transport.send(r)];case 3:return o.sent(),e.resolve(),[3,5];case 4:return n=o.sent(),e.reject(n),[3,5];case 5:return[3,0];case 6:return[2]}})})},t.concatBuffers=function(t){for(var e=t.map(function(t){return t.byteLength}).reduce(function(t,e){return t+e}),r=new Uint8Array(e),n=0,o=0,s=t;o<s.length;o++){var i=s[o];r.set(new Uint8Array(i),n),n+=i.byteLength}return r},t}();exports.TransportSendQueue=TransportSendQueue;var PromiseSource=function(){function t(){var t=this;this.promise=new Promise(function(e,r){var n;return n=[e,r],t.resolver=n[0],t.rejecter=n[1],n})}return t.prototype.resolve=function(){this.resolver()},t.prototype.reject=function(t){this.rejecter(t)},t}();
//# sourceMappingURL=/sm/60eda58e8f19ee736b4e7524b5bf5929e1596e131fd5beec40f02b2cc7af5847.map