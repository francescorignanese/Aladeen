/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/@microsoft/signalr@3.1.0/dist/esm/HttpConnection.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,s){function i(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(i,a)}c((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};import{DefaultHttpClient}from"./DefaultHttpClient";import{LogLevel}from"./ILogger";import{HttpTransportType,TransferFormat}from"./ITransport";import{LongPollingTransport}from"./LongPollingTransport";import{ServerSentEventsTransport}from"./ServerSentEventsTransport";import{Arg,createLogger,Platform}from"./Utils";import{WebSocketTransport}from"./WebSocketTransport";var MAX_REDIRECTS=100,WebSocketModule=null,EventSourceModule=null;if(Platform.isNode&&"undefined"!=typeof require){var requireFunc="function"==typeof __webpack_require__?__non_webpack_require__:require;WebSocketModule=requireFunc("ws"),EventSourceModule=requireFunc("eventsource")}var HttpConnection=function(){function t(t,e){void 0===e&&(e={}),this.features={},this.negotiateVersion=1,Arg.isRequired(t,"url"),this.logger=createLogger(e.logger),this.baseUrl=this.resolveUrl(t),(e=e||{}).logMessageContent=e.logMessageContent||!1,Platform.isNode||"undefined"==typeof WebSocket||e.WebSocket?Platform.isNode&&!e.WebSocket&&WebSocketModule&&(e.WebSocket=WebSocketModule):e.WebSocket=WebSocket,Platform.isNode||"undefined"==typeof EventSource||e.EventSource?Platform.isNode&&!e.EventSource&&void 0!==EventSourceModule&&(e.EventSource=EventSourceModule):e.EventSource=EventSource,this.httpClient=e.httpClient||new DefaultHttpClient(this.logger),this.connectionState="Disconnected",this.connectionStarted=!1,this.options=e,this.onreceive=null,this.onclose=null}return t.prototype.start=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(n){switch(n.label){case 0:return t=t||TransferFormat.Binary,Arg.isIn(t,TransferFormat,"transferFormat"),this.logger.log(LogLevel.Debug,"Starting connection with transfer format '"+TransferFormat[t]+"'."),"Disconnected"!==this.connectionState?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting ",this.startInternalPromise=this.startInternal(t),[4,this.startInternalPromise]);case 1:return n.sent(),"Disconnecting"!==this.connectionState?[3,3]:(e="Failed to start the HttpConnection before stop() was called.",this.logger.log(LogLevel.Error,e),[4,this.stopPromise]);case 2:return n.sent(),[2,Promise.reject(new Error(e))];case 3:if("Connected"!==this.connectionState)return e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(LogLevel.Error,e),[2,Promise.reject(new Error(e))];n.label=4;case 4:return this.connectionStarted=!0,[2]}})})},t.prototype.send=function(t){return"Connected"!==this.connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new TransportSendQueue(this.transport)),this.sendQueue.send(t))},t.prototype.stop=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(n){switch(n.label){case 0:return"Disconnected"===this.connectionState?(this.logger.log(LogLevel.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):"Disconnecting"===this.connectionState?(this.logger.log(LogLevel.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise(function(t){e.stopPromiseResolver=t}),[4,this.stopInternal(t)]);case 1:return n.sent(),[4,this.stopPromise];case 2:return n.sent(),[2]}})})},t.prototype.stopInternal=function(t){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:this.stopError=t,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:return r.sent(),[3,4];case 3:return r.sent(),[3,4];case 4:if(!this.sendQueue)return[3,9];r.label=5;case 5:return r.trys.push([5,7,,8]),[4,this.sendQueue.stop()];case 6:return r.sent(),[3,8];case 7:return e=r.sent(),this.logger.log(LogLevel.Error,"TransportSendQueue.stop() threw error '"+e+"'."),[3,8];case 8:this.sendQueue=void 0,r.label=9;case 9:if(!this.transport)return[3,14];r.label=10;case 10:return r.trys.push([10,12,,13]),[4,this.transport.stop()];case 11:return r.sent(),[3,13];case 12:return n=r.sent(),this.logger.log(LogLevel.Error,"HttpConnection.transport.stop() threw error '"+n+"'."),this.stopConnection(),[3,13];case 13:return this.transport=void 0,[3,15];case 14:this.logger.log(LogLevel.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed."),this.stopConnection(),r.label=15;case 15:return[2]}})})},t.prototype.startInternal=function(t){return __awaiter(this,void 0,void 0,function(){var e,n,r,o,s,i;return __generator(this,function(a){switch(a.label){case 0:e=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,a.label=1;case 1:return a.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==HttpTransportType.WebSockets?[3,3]:(this.transport=this.constructTransport(HttpTransportType.WebSockets),[4,this.startTransport(e,t)]):[3,5];case 2:return a.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:n=null,r=0,o=function(){var t;return __generator(this,function(o){switch(o.label){case 0:return[4,s.getNegotiationResponse(e)];case 1:if(n=o.sent(),"Disconnecting"===s.connectionState||"Disconnected"===s.connectionState)throw new Error("The connection was stopped during negotiation.");if(n.error)throw new Error(n.error);if(n.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return n.url&&(e=n.url),n.accessToken&&(t=n.accessToken,s.accessTokenFactory=function(){return t}),r++,[2]}})},s=this,a.label=6;case 6:return[5,o()];case 7:a.sent(),a.label=8;case 8:if(n.url&&r<MAX_REDIRECTS)return[3,6];a.label=9;case 9:if(r===MAX_REDIRECTS&&n.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(e,this.options.transport,n,t)];case 10:a.sent(),a.label=11;case 11:return this.transport instanceof LongPollingTransport&&(this.features.inherentKeepAlive=!0),"Connecting "===this.connectionState&&(this.logger.log(LogLevel.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return i=a.sent(),this.logger.log(LogLevel.Error,"Failed to start the connection: "+i),this.connectionState="Disconnected",this.transport=void 0,[2,Promise.reject(i)];case 13:return[2]}})})},t.prototype.getNegotiationResponse=function(t){return __awaiter(this,void 0,void 0,function(){var e,n,r,o,s,i,a;return __generator(this,function(c){switch(c.label){case 0:return this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(r=c.sent())&&((e={}).Authorization="Bearer "+r,n=e),c.label=2;case 2:o=this.resolveNegotiateUrl(t),this.logger.log(LogLevel.Debug,"Sending negotiation request: "+o+"."),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this.httpClient.post(o,{content:"",headers:n})];case 4:return 200!==(s=c.sent()).statusCode?[2,Promise.reject(new Error("Unexpected status code returned from negotiate "+s.statusCode))]:((!(i=JSON.parse(s.content)).negotiateVersion||i.negotiateVersion<1)&&(i.connectionToken=i.connectionId),[2,i]);case 5:return a=c.sent(),this.logger.log(LogLevel.Error,"Failed to complete negotiation with the server: "+a),[2,Promise.reject(a)];case 6:return[2]}})})},t.prototype.createConnectUrl=function(t,e){return e?t+(-1===t.indexOf("?")?"?":"&")+"id="+e:t},t.prototype.createTransport=function(t,e,n,r){return __awaiter(this,void 0,void 0,function(){var o,s,i,a,c,u,l,p,h,g,f;return __generator(this,function(d){switch(d.label){case 0:return o=this.createConnectUrl(t,n.connectionToken),this.isITransport(e)?(this.logger.log(LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,[4,this.startTransport(o,r)]):[3,2];case 1:return d.sent(),this.connectionId=n.connectionId,[2];case 2:s=[],i=n.availableTransports||[],a=n,c=0,u=i,d.label=3;case 3:return c<u.length?(l=u[c],(p=this.resolveTransportOrError(l,e,r))instanceof Error?(s.push(l.transport+" failed: "+p),[3,12]):[3,4]):[3,13];case 4:if(!this.isITransport(p))return[3,12];if(this.transport=p,a)return[3,9];d.label=5;case 5:return d.trys.push([5,7,,8]),[4,this.getNegotiationResponse(t)];case 6:return a=d.sent(),[3,8];case 7:return h=d.sent(),[2,Promise.reject(h)];case 8:o=this.createConnectUrl(t,a.connectionToken),d.label=9;case 9:return d.trys.push([9,11,,12]),[4,this.startTransport(o,r)];case 10:return d.sent(),this.connectionId=a.connectionId,[2];case 11:return g=d.sent(),this.logger.log(LogLevel.Error,"Failed to start the transport '"+l.transport+"': "+g),a=void 0,s.push(l.transport+" failed: "+g),"Connecting "!==this.connectionState?(f="Failed to select transport before stop() was called.",this.logger.log(LogLevel.Debug,f),[2,Promise.reject(new Error(f))]):[3,12];case 12:return c++,[3,3];case 13:return s.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+s.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}})})},t.prototype.constructTransport=function(t){switch(t){case HttpTransportType.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new WebSocketTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket);case HttpTransportType.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource);case HttpTransportType.LongPolling:return new LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1);default:throw new Error("Unknown transport: "+t+".")}},t.prototype.startTransport=function(t,e){var n=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(t){return n.stopConnection(t)},this.transport.connect(t,e)},t.prototype.resolveTransportOrError=function(t,e,n){var r=HttpTransportType[t.transport];if(null==r)return this.logger.log(LogLevel.Debug,"Skipping transport '"+t.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+t.transport+"' because it is not supported by this client.");if(!transportMatches(e,r))return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it was disabled by the client."),new Error("'"+HttpTransportType[r]+"' is disabled by the client.");if(!(t.transferFormats.map(function(t){return TransferFormat[t]}).indexOf(n)>=0))return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it does not support the requested transfer format '"+TransferFormat[n]+"'."),new Error("'"+HttpTransportType[r]+"' does not support "+TransferFormat[n]+".");if(r===HttpTransportType.WebSockets&&!this.options.WebSocket||r===HttpTransportType.ServerSentEvents&&!this.options.EventSource)return this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it is not supported in your environment.'"),new Error("'"+HttpTransportType[r]+"' is not supported in your environment.");this.logger.log(LogLevel.Debug,"Selecting transport '"+HttpTransportType[r]+"'.");try{return this.constructTransport(r)}catch(t){return t}},t.prototype.isITransport=function(t){return t&&"object"==typeof t&&"connect"in t},t.prototype.stopConnection=function(t){if(this.logger.log(LogLevel.Debug,"HttpConnection.stopConnection("+t+") called while in state "+this.connectionState+"."),this.transport=void 0,t=this.stopError||t,this.stopError=void 0,"Disconnected"!==this.connectionState)if("Connecting "!==this.connectionState){if("Disconnecting"===this.connectionState&&this.stopPromiseResolver(),t?this.logger.log(LogLevel.Error,"Connection disconnected with error '"+t+"'."):this.logger.log(LogLevel.Information,"Connection disconnected."),this.connectionId=void 0,this.connectionState="Disconnected",this.onclose&&this.connectionStarted){this.connectionStarted=!1;try{this.onclose(t)}catch(e){this.logger.log(LogLevel.Error,"HttpConnection.onclose("+t+") threw error '"+e+"'.")}}}else this.logger.log(LogLevel.Warning,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection hasn't yet left the in the connecting state.");else this.logger.log(LogLevel.Debug,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection is already in the disconnected state.")},t.prototype.resolveUrl=function(t){if(0===t.lastIndexOf("https://",0)||0===t.lastIndexOf("http://",0))return t;if(!Platform.isBrowser||!window.document)throw new Error("Cannot resolve '"+t+"'.");var e=window.document.createElement("a");return e.href=t,this.logger.log(LogLevel.Information,"Normalizing '"+t+"' to '"+e.href+"'."),e.href},t.prototype.resolveNegotiateUrl=function(t){var e=t.indexOf("?"),n=t.substring(0,-1===e?t.length:e);return"/"!==n[n.length-1]&&(n+="/"),n+="negotiate",-1===(n+=-1===e?"":t.substring(e)).indexOf("negotiateVersion")&&(n+=-1===e?"?":"&",n+="negotiateVersion="+this.negotiateVersion),n},t}();export{HttpConnection};function transportMatches(t,e){return!t||0!=(e&t)}var TransportSendQueue=function(){function t(t){this.transport=t,this.buffer=[],this.executing=!0,this.sendBufferedData=new PromiseSource,this.transportResult=new PromiseSource,this.sendLoopPromise=this.sendLoop()}return t.prototype.send=function(t){return this.bufferData(t),this.transportResult||(this.transportResult=new PromiseSource),this.transportResult.promise},t.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},t.prototype.bufferData=function(t){if(this.buffer.length&&typeof this.buffer[0]!=typeof t)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof t);this.buffer.push(t),this.sendBufferedData.resolve()},t.prototype.sendLoop=function(){return __awaiter(this,void 0,void 0,function(){var e,n,r;return __generator(this,function(o){switch(o.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(o.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new PromiseSource,e=this.transportResult,this.transportResult=void 0,n="string"==typeof this.buffer[0]?this.buffer.join(""):t.concatBuffers(this.buffer),this.buffer.length=0,o.label=2;case 2:return o.trys.push([2,4,,5]),[4,this.transport.send(n)];case 3:return o.sent(),e.resolve(),[3,5];case 4:return r=o.sent(),e.reject(r),[3,5];case 5:return[3,0];case 6:return[2]}})})},t.concatBuffers=function(t){for(var e=t.map(function(t){return t.byteLength}).reduce(function(t,e){return t+e}),n=new Uint8Array(e),r=0,o=0,s=t;o<s.length;o++){var i=s[o];n.set(new Uint8Array(i),r),r+=i.byteLength}return n},t}();export{TransportSendQueue};var PromiseSource=function(){function t(){var t=this;this.promise=new Promise(function(e,n){var r;return r=[e,n],t.resolver=r[0],t.rejecter=r[1],r})}return t.prototype.resolve=function(){this.resolver()},t.prototype.reject=function(t){this.rejecter(t)},t}();
//# sourceMappingURL=/sm/0cdde6dd3e9a6868c6dddaa78b400320e9eb9357b9384cb400a5ae6d9d1db81f.map